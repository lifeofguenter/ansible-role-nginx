user www-data www-data;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

worker_processes auto;
worker_rlimit_nofile 100000;
pcre_jit on;

events {
  use epoll;
  worker_connections 2048;
  multi_accept on;
}

http {
  {% if nginx_map_hash_max_size is defined %}
  map_hash_max_size {{ nginx_map_hash_max_size }};
  {% endif %}
  include       mime.types;
  default_type  application/octet-stream;

  resolver 8.8.8.8 8.8.4.4 valid=600s;
  resolver_timeout 4s;

  # make usage of $https dynamic
  map $https $fcgi_https {
    on on;
  }

  # make usage of $scheme dynamic
  map $http_x_forwarded_proto $the_scheme {
    default $scheme;
    https https;
  }

  # security
  server_tokens off;

  # performance
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  access_log off;
  open_file_cache max=10000 inactive=30s;
  open_file_cache_valid 60s;
  open_file_cache_min_uses 2;
  open_file_cache_errors on;

  keepalive_requests 1024;
  keepalive_timeout 120;
  send_timeout 60s;
  client_body_timeout 60s;
  client_max_body_size 100M;
  reset_timedout_connection on;

  # vhosts
  include vhosts/*.conf;

  # special munin-node vhost
  include common/munin-node.conf;
}
