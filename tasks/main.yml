---

- name: Get current nginx version
  command: /usr/sbin/nginx -v
  register: nginx_current
  ignore_errors: yes

- name: Install nginx
  include: nginx.yml
  when: nginx_current.rc != 0 or nginx_current.stderr.find('nginx/{{ nginx_version }}') == -1

- name: Check if munin-node is installed
  command: dpkg -L munin-node
  register: dpkg_munin_node_check
  ignore_errors: yes

- name: Configure munin plugin
  include: munin-plugin.yml
  when: dpkg_munin_node_check.rc == 0

- name: Check if fail2ban is installed
  command: dpkg -L fail2ban
  register: dpkg_fail2ban_check
  ignore_errors: yes

- name: Configure fail2ban jail
  include: fail2ban-jail.yml
  when: dpkg_fail2ban_check.rc == 0